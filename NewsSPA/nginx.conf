server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # SPA fallback
    location / {
        try_files $uri /index.html;
    }

    # Отдаём предсжатые файлы
    gzip_static on;       # если есть .gz — отдать его
    brotli on;            # если есть .br — отдать его
    brotli_static on;     # если есть .br файл — отдать его
    brotli_types text/plain text/css application/javascript application/json;

    # Кэширование статики
    location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|ttf|svg)$ {
        expires 6M;
        access_log off;
        add_header Cache-Control "public";
    }

    # Заголовки безопасности
    add_header X-Content-Type-Options nosniff;

    add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval';
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https:;
    connect-src 'self' https:;
    frame-src 'self'
    " always; 

    # default-src 'self'; 
    # все ресурсы по умолчанию только с нашего домена

    # script-src 'self' 'unsafe-inline' 'unsafe-eval'; 
    # 'self' → скрипты только локальные
    # 'unsafe-inline' → разрешаем инлайновые <script> и атрибуты onclick (иначе ломаются SPA)
    # 'unsafe-eval' → нужен для некоторых сборщиков/DevTools (React/Vite), иначе не работают eval-подобные конструкции

    # style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    # 'self' → стили только локальные
    # 'unsafe-inline' → разрешаем инлайновые стили (например style="...")
    # https://fonts.googleapis.com → разрешаем подключение Google Fonts

    # font-src 'self' https://fonts.gstatic.com;
    # шрифты локальные и с CDN Google Fonts

    # img-src 'self' data: https:;
    # 'self' → картинки локальные
    # data: → разрешаем base64-картинки
    # https: → разрешаем любые картинки с HTTPS-источников (щадящий вариант, иначе ломаются внешние изображения)

    # connect-src 'self' https:;
    # API-запросы к нашему домену и любым HTTPS-бэкендам

    # frame-src 'self' https://*.telegram.org;
    # разрешаем открывать фреймы только с нашего домена
    # например, нужно работать в Telegram WebView → расширить до frame-src 'self' https://*.telegram.org
}